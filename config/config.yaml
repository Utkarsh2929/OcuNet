# ===========================================
# OCUNET PHASE 2 - IMPROVED CONFIGURATION
# ===========================================

# Dataset Configuration
dataset:
  phase1_root: "data/dataset"
  use_phase1: true

  phase2_root: "data/rfmid"
  use_phase2: true

  image_size: 224
  train_split: 0.7
  val_split: 0.15
  test_split: 0.15
  random_seed: 42

  # Minimum samples per class
  min_samples_per_class: 10

  # Oversampling (disabled — use effective class-balanced weights instead)
  oversample_rare_classes: false
  oversample_threshold: 50
  oversample_factor: 3

# Preprocessing (NEW - applied before augmentation)
preprocessing:
  fundus_roi_crop: true        # Detect and crop to fundus ROI, remove black borders
  roi_padding: 0.02            # Extra padding around detected ROI

  clahe: true                  # Illumination normalization via CLAHE
  clahe_clip_limit: 2.0
  clahe_channel: "green"       # "green" (best for fundus) or "lab"

# Training Configuration
training:
  batch_size: 16
  num_epochs: 150
  learning_rate: 0.00005
  weight_decay: 0.0001
  early_stopping_patience: 25
  num_workers: 0

  # Dynamic thresholding
  threshold: 0.5
  use_class_specific_thresholds: true

  # Warmup
  warmup_epochs: 5

  # Label smoothing — disabled for multi-label sigmoid (has no effect)
  # label_smoothing: 0.0

  # Class-balanced loss reweighting (replaces naive oversampling)
  use_effective_weights: true
  effective_weights_beta: 0.9999

  # Gradient accumulation (for larger effective batch with 384px images)
  gradient_accumulation_steps: 1   # Set to 2-4 if using image_size: 384

  # Hard negative mining (targets low-precision problem)
  hard_negative_mining: false
  hard_negative_weight: 3.0

# Model Configuration
model:
  # Backbone options: efficientnet_b0, efficientnet_b2, efficientnet_v2_s,
  #                   convnext_tiny, convnext_small, swin_t
  architecture: "efficientnet_b2"
  pretrained: true
  dropout_rate: 0.5

  # Loss function: "asl", "focal", or "bce"
  loss_function: "asl"
  asl_gamma_neg: 4
  asl_gamma_pos: 1
  asl_clip: 0.05
  focal_loss_gamma: 2.0       # Only used if loss_function: "focal"

  multi_label: true

# Augmentation Configuration (toned down for medical imaging)
augmentation:
  # Geometric
  rotation_degrees: 45
  horizontal_flip: true
  vertical_flip: false         # Disabled — unrealistic for fundus imaging
  zoom_range: [0.8, 1.2]
  shear_range: 15

  # Color (reduced extremes for medical images)
  brightness_range: [0.7, 1.3]   # Was [0.6, 1.4]
  contrast_range: [0.7, 1.3]     # Was [0.6, 1.4]
  saturation_range: [0.8, 1.2]
  hue_range: 0.05                # Was 0.1

  # Advanced
  random_erasing: true
  random_erasing_prob: 0.3
  random_erasing_scale: [0.02, 0.2]

  # RandAugment
  use_randaugment: true
  randaugment_n: 2
  randaugment_m: 7               # Was 9

  # Disabled for multi-label
  mixup_alpha: 0.0
  cutmix_alpha: 0.0

# Calibration (NEW)
calibration:
  strategy: "f1"               # "f1" or "precision_at_recall"
  min_recall: 0.8              # For precision_at_recall strategy

# Output
output:
  checkpoint_dir: "checkpoints"
  results_dir: "evaluation_results"
  explainability_dir: "explainability_results"

# Experiment
experiment:
  name: "ocunet_phase2_improved"
  version: "2.2.0"